# https://circleci.com/docs/2.0/language-python/

version: 2
jobs:
  build:
    docker:
      - image: snowsec/snowalert-builder

    working_directory: ~/project

    steps:
      - checkout

      - restore_cache:
          keys:
          - app-venv-{{ checksum "src/setup.py" }}-0

      - run:
          name: install_dependencies
          command: |
            cd src
            python -m venv .venv
            .venv/bin/pip install --upgrade pip
            .venv/bin/pip install '.' '.[dev]'

      - save_cache:
          paths:
            - ./src/.venv
          key: app-venv-{{ checksum "src/setup.py" }}-0

      - run:
          name: run static analysis
          command: |
            cd src

            MYPYPATH="`pwd`/webui/backend/" \
              .venv/bin/mypy \
                --install-types \
                --non-interactive \
                --config-file mypy.ini \
                 ./runners \
                 ./scripts \
                 ./webui/backend/webui \
                 ./connectors \
                 ./../infra/terraform/external_function/snowalert/lambda-code

            .venv/bin/pytest -vv

            ./scripts/run-whitesource

workflows:
  version: 2
  docs_and_lambdas:
    jobs:
      - build
